<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tsiku Leave Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .header-left { display:flex; align-items:center; gap:16px; }
        #logo { height:70px; border-radius:8px; object-fit:contain; }
        h1 { color: #667eea; margin-bottom: 10px; font-size: 28px; }
        .info { color: #666; font-size: 14px; margin-top: 10px; }
        .rules-box { background: #f0f4ff; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #667eea; }
        .rules-box h4 { color: #667eea; margin-bottom: 8px; }
        .rules-box ul { margin-left: 20px; color: #555; font-size: 13px; }
        .rules-box li { margin: 5px 0; }
        .lunch-box { background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #ffc107; }
        .lunch-box h4 { color: #856404; margin-bottom: 8px; }
        .employee-selector { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .employee-selector select { padding: 10px 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; min-width: 200px; }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        .card h3 { color: #666; font-size: 14px; text-transform: uppercase; margin-bottom: 10px; }
        .card .value { font-size: 36px; font-weight: bold; color: #667eea; }
        .card .subtext { color: #999; font-size: 12px; margin-top: 5px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { flex: 1; min-width: 150px; padding: 15px; background: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; box-shadow: 0 5[...]
        .tab.active { background: #667eea; color: white; box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .content { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .section { display: none; }
        .section.active { display: block; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border 0.3s; font-famil[...]
        .input-group textarea { min-height: 80px; resize: vertical; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { outline: none; border-color: #667eea; }
        .location-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: #e3f2fd; color: #1976d2; }
        .lunch-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .lunch-badge.approved { background: #d4edda; color: #155724; }
        .lunch-badge.pending { background: #fff3cd; color: #856404; }
        .lunch-badge.normal { background: #e3f2fd; color: #1976d2; }
        .late-indicator { padding: 10px; border-radius: 5px; margin-top: 10px; font-weight: 600; display: none; }
        .late-indicator.on-time { background: #d4edda; color: #155724; display: block; }
        .late-indicator.late { background: #fff3cd; color: #856404; display: block; }
        .late-indicator.very-late { background: #f8d7da; color: #721c24; display: block; }
        .btn { background: #667eea; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; margin-right: 10px; ma[...]
        .btn:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-secondary:hover { background: #d0d0d0; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-warning:hover { background: #e0a800; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background: #f5f5f5; font-weight: 600; color: #667eea; }
        tr:hover { background: #f9f9f9; }
        .late-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .late-badge.on-time { background: #d4edda; color: #155724; }
        .late-badge.late { background: #fff3cd; color: #856404; }
        .late-badge.very-late { background: #f8d7da; color: #721c24; }
        .comment-cell { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; color: #666; font-size: 13px; }
        .comment-cell:hover { color: #667eea; text-decoration: underline; }
        .export-section { margin-top: 30px; padding-top: 30px; border-top: 2px solid #e0e0e0; }
        .employee-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        .employee-card { background: #f9f9f9; padding: 20px; border-radius: 10px; border: 2px solid #e0e0e0; transition: all 0.3s; }
        .employee-card:hover { border-color: #667eea; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2); }
        .employee-card h4 { color: #667eea; margin-bottom: 10px; }
        .employee-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .employee-stats div { background: white; padding: 10px; border-radius: 5px; text-align: center; }
        .employee-stats .label { font-size: 11px; color: #666; text-transform: uppercase; }
        .employee-stats .stat-value { font-size: 20px; font-weight: bold; color: #667eea; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal h2 { color: #667eea; margin-bottom: 20px; }
        .modal h3 { color: #dc3545; margin-bottom: 15px; }
        .close-modal { float: right; font-size: 28px; font-weight: bold; color: #999; cursor: pointer; }
        .close-modal:hover { color: #333; }
        .radio-group { display: flex; gap: 20px; margin-top: 10px; }
        .radio-group label { display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer; }
        .radio-group input[type="radio"] { width: auto; margin: 0; }
        .warning-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .warning-box p { color: #856404; margin: 5px 0; font-size: 14px; }
        .warning-box strong { color: #721c24; }

        /* Approval badges */
        .approval-badge { display:inline-block; padding:6px 10px; border-radius:6px; font-weight:700; font-size:12px; }
        .approval-badge.approved { background:#d4edda; color:#155724; }
        .approval-badge.rejected { background:#f8d7da; color:#721c24; }
        .approval-badge.pending { background:#fff3cd; color:#856404; }

        /* Report note style */
        .report-note { margin-top: 10px; color: #444; font-size: 14px; font-weight:600; }

        /* Print / Report improvements */
        @media print {
            body { background: white; color: #111; padding: 0; }
            .header, .content, .employee-card, .card { box-shadow: none; border-radius: 0; }
            .no-print { display:none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="header-left">
                    <!-- Logo: place your logo file at assets/logo.png or provide a URL here -->
                    <img id="logo" src="assets/logo.png" alt="Tsiku Logo" onerror="this.style.display='none'"/>
                    <div>
                        <h1>Tsiku Leave Tracker</h1>
                        <div class="info">Official Arrival: 07:45 AM | Accumulation: 45 minutes per day on time</div>
                        <div class="rules-box">
                            <h4>üìã Accumulation Rules:</h4>
                            <ul>
                                <li><strong>On time</strong> (by 07:55 AM): +45 minutes</li>
                                <li><strong>Late</strong> (after 07:55 AM): 45 minutes - late minutes</li>
                                <li><strong>Sick days</strong>: No accumulation</li>
                                <li><strong>Example:</strong> Arrive 08:15 AM (30 min late) = 45 - 30 = 15 minutes accumulated</li>
                            </ul>
                        </div>
                        <div class="lunch-box">
                            <h4>üçΩÔ∏è Lunch Period Rules:</h4>
                            <ul>
                                <li><strong>Group A:</strong> 12:00 PM - 1:00 PM (strict)</li>
                                <li><strong>Group B:</strong> 1:00 PM - 2:00 PM (strict)</li>
                                <li><strong>Late return:</strong> Deduct exceeded minutes from daily 45 min</li>
                                <li><strong>Example:</strong> Group A returns 13:10 (10 min late) = 45 - 10 = 35 min accumulated</li>
                                <li><strong>‚ö†Ô∏è Late return requires:</strong> Manager approval + reason in comments</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="employee-selector no-print">
                    <label style="font-weight: 600; color: #333;">View Employee:</label>
                    <select id="employeeSelect" onchange="switchEmployee()"></select>
                    <button class="btn btn-success" onclick="openAddEmployeeModal()">+ Add Employee</button>
                </div>
            </div>
        </div>
        
        <div class="cards">
            <div class="card"><h3>Total Balance</h3><div class="value" id="totalBalance">0.00</div><div class="subtext">days available</div></div>
            <div class="card"><h3>This Month</h3><div class="value" id="monthAccumulated">0.00</div><div class="subtext">days accumulated</div></div>
            <div class="card"><h3>Days Worked</h3><div class="value" id="totalWorked">0</div><div class="subtext">total workdays</div></div>
            <div class="card"><h3>Total Employees</h3><div class="value" id="totalEmployees">0</div><div class="subtext">registered</div></div>
            <div class="card"><h3>Sick Accrued (This Year)</h3><div class="value" id="sickAccrued">0</div><div class="subtext">days available</div></div>
        </div>
        
        <div class="tabs no-print">
            <button class="tab active" onclick="showTab(event, 'entry')">Record Entry</button>
            <button class="tab" onclick="showTab(event, 'monthly')">Monthly Summary</button>
            <button class="tab" onclick="showTab(event, 'balance')">Balance Details</button>
            <button class="tab" onclick="showTab(event, 'employees')">All Employees</button>
        </div>
        
        <div class="content">
            <div id="entry" class="section active">
                <h2 style="margin-bottom: 20px; color: #667eea;">Record Daily Attendance</h2>
                <div class="input-group"><label>Employee</label><select id="entryEmployee"></select></div>
                <div class="input-group"><label>Date (From)</label><input type="date" id="workDate" /></div>
                <div class="input-group" id="dateRangeGroup" style="display: none;"><label>Leave Period (To Date)</label><input type="date" id="toDate" /><small style="color: #666; margin-top: 5px; di[...]
                <div class="input-group"><label><input type="checkbox" id="menlynOffice" onchange="toggleLocation()" style="width: auto; margin-right: 8px;" checked />Working at Menlyn Office</label><[...]
                <div class="input-group" id="locationGroup" style="display: none;"><label>Location (Out of Office)</label><select id="location"><option value="KZN">KZN</option><option value="GP">GP</o[...]
                <div class="input-group" id="arrivalGroup"><label>Arrival Time (Official: 07:45 AM)</label><input type="time" id="arrivalTime" value="07:45" onchange="calculateLate()" /></div>
                <div id="lateIndicator" class="late-indicator"></div>
                
                <!-- LUNCH PERIOD SECTION -->
                <div class="input-group" id="lunchGroup">
                    <label>Lunch Group Assignment</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="lunchGroup" value="A" checked onchange="calculateLunchPenalty()">
                            Group A (12:00-13:00)
                        </label>
                        <label>
                            <input type="radio" name="lunchGroup" value="B" onchange="calculateLunchPenalty()">
                            Group B (13:00-14:00)
                        </label>
                    </div>
                </div>
                
                <div class="input-group" id="lunchTimeGroup">
                    <label>Actual Lunch Time Taken</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 12px; color: #666;">Start Time</label>
                            <input type="time" id="lunchStart" onchange="calculateLunchPenalty()" />
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666;">End Time</label>
                            <input type="time" id="lunchEnd" onchange="calculateLunchPenalty()" />
                        </div>
                    </div>
                </div>
                
                <div id="lunchIndicator" class="late-indicator" style="display: none;"></div>
                
                <div class="input-group"><label>Status</label><select id="dayStatus" onchange="toggleArrivalTime()"><option value="worked">Worked</option><option value="sick">Sick Leave</option><optio[...]
                <div class="input-group" id="leaveAmountGroup" style="display: none;"><label>Leave Days Per Day</label><input type="number" id="leaveTaken" step="0.5" value="1" min="0.5" max="1" /><sm[...]
                <div class="input-group"><label>Comments / Notes (Optional)</label><textarea id="comments" placeholder="Add any notes..."></textarea></div>
                <button class="btn" onclick="addEntry()">Add Entry</button>
            </div>
            
            <div id="monthly" class="section">
                <h2 style="margin-bottom: 20px; color: #667eea;">Monthly Summary - <span id="monthlyEmployeeName"></span></h2>
                <table><thead><tr><th>Month</th><th>Days Worked</th><th>Sick</th><th>Annual</th><th>Study</th><th>Family</th><th>Late Days</th><th>Lunch Violations</th><th>Mins</th><th>Days</th></tr><[...]
                <div class="export-section">
                    <h3 style="margin-bottom: 15px; color: #667eea;">Export Data</h3>
                    <div class="report-note">Reports must be beautiful and nice. The exported CSV includes a header that notes it was generated by Tsiku Leave Tracker.</div>
                    <button class="btn" onclick="exportToCSV()">Download CSV</button>
                    <button class="btn btn-secondary" onclick="exportAllEmployeesCSV()">Download All CSV</button>
                </div>
            </div>
            
            <div id="balance" class="section">
                <h2 style="margin-bottom: 20px; color: #667eea;">Balance Details - <span id="balanceEmployeeName"></span></h2>
                <div style="overflow-x: auto;"><table><thead><tr><th>Date</th><th>Location</th><th>Arrival</th><th>Lunch Period</th><th>Status</th><th>Late</th><th>Lunch Deduct</th><th>Mins</th><th>Le[...]
            </div>
            
            <div id="employees" class="section">
                <h2 style="margin-bottom: 20px; color: #667eea;">All Employees</h2>
                <div class="employee-list" id="employeeList"></div>
                <div class="export-section"><h3 style="margin-bottom: 15px; color: #667eea;">Manage Data</h3><button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button></div>
            </div>
        </div>
    </div>
    
    <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAddEmployeeModal()">&times;</span>
            <h2>Add New Employee</h2>
            <div class="input-group"><label>Employee Name</label><input type="text" id="newEmployeeName" placeholder="e.g., John Doe" /></div>
            <div class="input-group"><label>Employee ID (Optional)</label><input type="text" id="newEmployeeId" placeholder="e.g., EMP001" /></div>
            <div class="input-group">
                <label>Default Lunch Group</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="newEmployeeLunchGroup" value="A" checked>
                        Group A (12:00-13:00)
                    </label>
                    <label>
                        <input type="radio" name="newEmployeeLunchGroup" value="B">
                        Group B (13:00-14:00)
                    </label>
                </div>
            </div>
            <button class="btn" onclick="addEmployee()">Add Employee</button>
            <button class="btn btn-secondary" onclick="closeAddEmployeeModal()">Cancel</button>
        </div>
    </div>
    
    <!-- LUNCH APPROVAL MODAL -->
    <div id="lunchApprovalModal" class="modal">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Manager Approval Required</h3>
            <div class="warning-box">
                <p><strong>Employee exceeded lunch period!</strong></p>
                <p id="lunchViolationDetails"></p>
            </div>
            <div class="input-group">
                <label>Manager Name (Approving this late return)</label>
                <input type="text" id="managerName" placeholder="e.g., John Manager" />
            </div>
            <div class="input-group">
                <label>Reason for Late Return (Required)</label>
                <textarea id="lunchReason" placeholder="Explain why employee was late returning from lunch..." rows="4"></textarea>
            </div>
            <button class="btn btn-success" onclick="approveLunchViolation()">Approve & Continue</button>
            <button class="btn btn-secondary" onclick="cancelLunchViolation()">Cancel Entry</button>
        </div>
    </div>
    
    <div id="leaveApprovalModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeLeaveApprovalModal()">&times;</span>
            <h3>Leave Approval</h3>
            <div class="input-group">
                <label>Approver Name</label>
                <input type="text" id="leaveApproverName" placeholder="e.g., Manager Name" />
            </div>
            <div class="input-group">
                <label>Comments / Reason (optional)</label>
                <textarea id="leaveApprovalReason" rows="4" placeholder="Provide reason or notes..."></textarea>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn btn-success" id="leaveApproveBtn" onclick="confirmLeaveApproval('approved')">Approve</button>
                <button class="btn btn-danger" id="leaveRejectBtn" onclick="confirmLeaveApproval('rejected')">Reject</button>
                <button class="btn btn-secondary" onclick="closeLeaveApprovalModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="commentModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeCommentModal()">&times;</span>
            <h2>Entry Comments</h2>
            <p id="commentContent" style="color: #333; line-height: 1.6; white-space: pre-wrap;"></p>
            <button class="btn btn-secondary" onclick="closeCommentModal()">Close</button>
        </div>
    </div>

    <script>
        const OFFICIAL_ARRIVAL = "07:45";
        const GRACE_PERIOD_MINUTES = 10;
        const DAILY_ACCUMULATION_MINUTES = 45;
        
        const LUNCH_PERIODS = {
            'A': { start: '12:00', end: '13:00' },
            'B': { start: '13:00', end: '14:00' }
        };
        
        let employees = [];
        let entries = [];
        let currentEmployeeId = null;
        let pendingEntry = null;

        // For leave approval modal context
        let leaveApprovalContext = { empId: null, entryDate: null, action: null, entryIndex: null };

        function setDefaultDate() {
            document.getElementById('workDate').value = new Date().toISOString().split('T')[0];
        }

        function loadData() {
            const savedEmployees = localStorage.getItem('employees');
            const savedEntries = localStorage.getItem('leaveEntries');
            
            if (savedEmployees) employees = JSON.parse(savedEmployees);
            if (savedEntries) entries = JSON.parse(savedEntries);
            
            if (employees.length === 0) {
                employees.push({ 
                    id: 'emp_' + Date.now(), 
                    name: 'Default Employee', 
                    employeeId: 'EMP001',
                    lunchGroup: 'A'
                });
                saveData();
            }
            
            currentEmployeeId = employees[0].id;
            populateEmployeeSelectors();
        }

        function saveData() {
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('leaveEntries', JSON.stringify(entries));
        }

        function populateEmployeeSelectors() {
            [document.getElementById('employeeSelect'), document.getElementById('entryEmployee')].forEach(select => {
                select.innerHTML = '';
                employees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.name} (${emp.employeeId}) - Group ${emp.lunchGroup || 'A'}`;
                    select.appendChild(option);
                });
                select.value = currentEmployeeId;
            });
            document.getElementById('totalEmployees').textContent = employees.length;
        }

        function switchEmployee() {
            currentEmployeeId = document.getElementById('employeeSelect').value;
            document.getElementById('entryEmployee').value = currentEmployeeId;
            
            // Set default lunch group for selected employee
            const emp = employees.find(e => e.id === currentEmployeeId);
            if (emp) {
                const lunchGroupRadio = document.querySelector(`input[name="lunchGroup"][value="${emp.lunchGroup || 'A'}"]`);
                if (lunchGroupRadio) lunchGroupRadio.checked = true;
            }
            
            updateAllDisplays();
        }

        function toggleLocation() {
            const checked = document.getElementById('menlynOffice').checked;
            document.getElementById('locationGroup').style.display = checked ? 'none' : 'block';
        }

        function calculateLate() {
            if (document.getElementById('dayStatus').value !== 'worked') return;
            const arrivalTime = document.getElementById('arrivalTime').value;
            if (!arrivalTime) return;
            
            const lateMinutes = Math.round((new Date('2000-01-01 ' + arrivalTime) - new Date('2000-01-01 07:45')) / 60000);
            const indicator = document.getElementById('lateIndicator');
            
            if (lateMinutes <= 10) {
                indicator.className = 'late-indicator on-time';
                indicator.innerHTML = '‚úÖ <strong>On Time!</strong> Will accumulate full 45 minutes';
            } else {
                const accumulated = 45 - lateMinutes;
                if (accumulated > 0) {
                    indicator.className = 'late-indicator late';
                    indicator.innerHTML = `‚ö†Ô∏è <strong>${lateMinutes} min late.</strong> Will accumulate: ${accumulated} min`;
                } else if (accumulated === 0) {
                    indicator.className = 'late-indicator very-late';
                    indicator.innerHTML = `‚ùå <strong>${lateMinutes} min late.</strong> No accumulation`;
                } else {
                    indicator.className = 'late-indicator very-late';
                    indicator.innerHTML = `‚ùå <strong>${lateMinutes} min late.</strong> DEDUCTION: ${accumulated} min`;
                }
            }
        }

        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function calculateLunchPenalty() {
            if (document.getElementById('dayStatus').value !== 'worked') return;
            
            const lunchGroup = document.querySelector('input[name="lunchGroup"]:checked').value;
            const lunchStart = document.getElementById('lunchStart').value;
            const lunchEnd = document.getElementById('lunchEnd').value;
            const indicator = document.getElementById('lunchIndicator');
            
            if (!lunchStart || !lunchEnd) {
                indicator.style.display = 'none';
                return;
            }
            
            const scheduledStart = LUNCH_PERIODS[lunchGroup].start;
            const scheduledEnd = LUNCH_PERIODS[lunchGroup].end;
            
            const scheduledEndMinutes = timeToMinutes(scheduledEnd);
            const actualEndMinutes = timeToMinutes(lunchEnd);
            
            // Calculate how many minutes late they returned
            const lateMinutes = Math.max(0, actualEndMinutes - scheduledEndMinutes);
            
            if (lateMinutes === 0) {
                indicator.className = 'late-indicator on-time';
                indicator.innerHTML = `‚úÖ <strong>Lunch on time!</strong> Group ${lunchGroup} (${scheduledStart}-${scheduledEnd})`;
                indicator.style.display = 'block';
            } else {
                const remainingAccumulation = DAILY_ACCUMULATION_MINUTES - lateMinutes;
                indicator.className = 'late-indicator very-late';
                indicator.innerHTML = `‚ùå <strong>${lateMinutes} min late return!</strong> Will deduct ${lateMinutes} min from daily 45 min. Final accumulation: ${remainingAccumulation} min<br><stron[...]
                indicator.style.display = 'block';
            }
        }

        function toggleArrivalTime() {
            const status = document.getElementById('dayStatus').value;
            const arrivalGroup = document.getElementById('arrivalGroup');
            const leaveGroup = document.getElementById('leaveAmountGroup');
            const lateIndicator = document.getElementById('lateIndicator');
            const dateRangeGroup = document.getElementById('dateRangeGroup');
            const lunchGroup = document.getElementById('lunchGroup');
            const lunchTimeGroup = document.getElementById('lunchTimeGroup');
            const lunchIndicator = document.getElementById('lunchIndicator');
            
            if (['annual', 'study', 'family'].includes(status)) {
                arrivalGroup.style.display = 'none';
                leaveGroup.style.display = 'block';
                dateRangeGroup.style.display = 'block';
                lateIndicator.style.display = 'none';
                lunchGroup.style.display = 'none';
                lunchTimeGroup.style.display = 'none';
                lunchIndicator.style.display = 'none';
            } else if (status === 'worked') {
                arrivalGroup.style.display = 'block';
                leaveGroup.style.display = 'none';
                dateRangeGroup.style.display = 'none';
                lunchGroup.style.display = 'block';
                lunchTimeGroup.style.display = 'block';
                calculateLate();
                calculateLunchPenalty();
            } else {
                arrivalGroup.style.display = 'none';
                leaveGroup.style.display = 'none';
                dateRangeGroup.style.display = 'none';
                lateIndicator.style.display = 'none';
                lunchGroup.style.display = 'none';
                lunchTimeGroup.style.display = 'none';
                lunchIndicator.style.display = 'none';
            }
        }

        function openAddEmployeeModal() {
            document.getElementById('addEmployeeModal').classList.add('active');
            document.getElementById('newEmployeeName').value = '';
            document.getElementById('newEmployeeId').value = '';
        }

        function closeAddEmployeeModal() {
            document.getElementById('addEmployeeModal').classList.remove('active');
        }

        function showComment(comment) {
            if (!comment || comment.trim() === '') {
                alert('No comments');
                return;
            }
            document.getElementById('commentContent').textContent = comment;
            document.getElementById('commentModal').classList.add('active');
        }

        function closeCommentModal() {
            document.getElementById('commentModal').classList.remove('active');
        }

        function addEmployee() {
            const name = document.getElementById('newEmployeeName').value.trim();
            const empId = document.getElementById('newEmployeeId').value.trim() || 'EMP' + (employees.length + 1).toString().padStart(3, '0');
            const lunchGroup = document.querySelector('input[name="newEmployeeLunchGroup"]:checked').value;
            
            if (!name) {
                alert('Please enter employee name');
                return;
            }

            employees.push({ 
                id: 'emp_' + Date.now(), 
                name: name, 
                employeeId: empId,
                lunchGroup: lunchGroup
            });
            saveData();
            populateEmployeeSelectors();
            closeAddEmployeeModal();
            updateAllDisplays();
            alert(`Employee ${name} added to Lunch Group ${lunchGroup}!`);
        }

        function addEntry() {
            const employeeId = document.getElementById('entryEmployee').value;
            const fromDate = document.getElementById('workDate').value;
            const toDate = document.getElementById('toDate').value;
            const status = document.getElementById('dayStatus').value;
            const location = document.getElementById('menlynOffice').checked ? 'Menlyn Office' : document.getElementById('location').value;
            const arrivalTime = document.getElementById('arrivalTime').value;
            const comments = document.getElementById('comments').value.trim();
            const leaveTaken = ['annual', 'study', 'family'].includes(status) ? parseFloat(document.getElementById('leaveTaken').value) : 0;
            
            // Lunch data
            const lunchGroup = document.querySelector('input[name="lunchGroup"]:checked')?.value || 'A';
            const lunchStart = document.getElementById('lunchStart').value;
            const lunchEnd = document.getElementById('lunchEnd').value;

            if (!fromDate) {
                alert('Please select a date');
                return;
            }

            // Handle date range for leave
            if (['annual', 'study', 'family', 'sick'].includes(status) && toDate) {
                const start = new Date(fromDate);
                const end = new Date(toDate);
                
                if (end < start) {
                    alert('End date must be after start date');
                    return;
                }

                let count = 0;
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const existingIndex = entries.findIndex(e => e.employeeId === employeeId && e.date === dateStr);
                    if (existingIndex >= 0) entries.splice(existingIndex, 1);

                    entries.push({
                        employeeId, date: dateStr, status, location,
                        arrivalTime: null, lateMinutes: 0, accumulatedMinutes: 0,
                        leaveTaken, comments,
                        lunchGroup: null, lunchStart: null, lunchEnd: null,
                        lunchLateMinutes: 0, managerApproval: null, lunchReason: null,
                        approvalStatus: null, approver: null, approvalReason: null
                    });
                    count++;
                }
                
                entries.sort((a, b) => new Date(a.date) - new Date(b.date));
                saveData();
                updateAllDisplays();
                resetForm();
                alert(`Leave recorded for ${count} days (${fromDate} to ${toDate})`);
                return;
            }

            // Single day entry - Check for lunch violation
            if (status === 'worked' && lunchStart && lunchEnd) {
                const scheduledEnd = LUNCH_PERIODS[lunchGroup].end;
                const scheduledEndMinutes = timeToMinutes(scheduledEnd);
                const actualEndMinutes = timeToMinutes(lunchEnd);
                const lunchLateMinutes = Math.max(0, actualEndMinutes - scheduledEndMinutes);
                
                if (lunchLateMinutes > 0) {
                    // Store pending entry data and show approval modal
                    const emp = employees.find(e => e.id === employeeId);
                    pendingEntry = {
                        employeeId, date: fromDate, status, location, arrivalTime,
                        lunchGroup, lunchStart, lunchEnd, lunchLateMinutes,
                        comments, leaveTaken
                    };
                    
                    document.getElementById('lunchViolationDetails').innerHTML = `
                        <p><strong>Employee:</strong> ${emp.name}</p>
                        <p><strong>Lunch Group:</strong> ${lunchGroup} (should end at ${scheduledEnd})</p>
                        <p><strong>Actual end:</strong> ${lunchEnd}</p>
                        <p><strong>Late by:</strong> ${lunchLateMinutes} minutes</p>
                        <p><strong>Deduction:</strong> ${lunchLateMinutes} min from daily 45 min accumulation</p>
                    `;
                    document.getElementById('managerName').value = '';
                    document.getElementById('lunchReason').value = '';
                    document.getElementById('lunchApprovalModal').classList.add('active');
                    return;
                }
            }

            // Process normal entry without lunch violation
            processEntry(employeeId, fromDate, status, location, arrivalTime, 
                        lunchGroup, lunchStart, lunchEnd, 0, null, null, comments, leaveTaken);
        }

        function approveLunchViolation() {
            const managerName = document.getElementById('managerName').value.trim();
            const lunchReason = document.getElementById('lunchReason').value.trim();
            
            if (!managerName) {
                alert('Please enter manager name');
                return;
            }
            
            if (!lunchReason) {
                alert('Please provide reason for late lunch return');
                return;
            }
            
            // Combine lunch reason with existing comments
            const fullComments = `[LUNCH LATE RETURN - Approved by: ${managerName}]\nReason: ${lunchReason}\n${pendingEntry.comments ? '\n' + pendingEntry.comments : ''}`;
            
            processEntry(
                pendingEntry.employeeId, pendingEntry.date, pendingEntry.status,
                pendingEntry.location, pendingEntry.arrivalTime,
                pendingEntry.lunchGroup, pendingEntry.lunchStart, pendingEntry.lunchEnd,
                pendingEntry.lunchLateMinutes, managerName, lunchReason,
                fullComments, pendingEntry.leaveTaken
            );
            
            document.getElementById('lunchApprovalModal').classList.remove('active');
            pendingEntry = null;
        }

        function cancelLunchViolation() {
            document.getElementById('lunchApprovalModal').classList.remove('active');
            pendingEntry = null;
        }

        function processEntry(employeeId, fromDate, status, location, arrivalTime,
                             lunchGroup, lunchStart, lunchEnd, lunchLateMinutes,
                             managerApproval, lunchReason, comments, leaveTaken) {
            
            const existingIndex = entries.findIndex(e => e.employeeId === employeeId && e.date === fromDate);
            if (existingIndex >= 0) {
                if (!confirm('Entry exists. Replace it?')) return;
                entries.splice(existingIndex, 1);
            }

            let accumulatedMinutes = 0, lateMinutes = 0;
            
            if (status === 'worked') {
                // Calculate arrival late penalty
                const late = Math.max(0, Math.round((new Date('2000-01-01 ' + arrivalTime) - new Date('2000-01-01 07:45')) / 60000));
                if (late <= 10) {
                    accumulatedMinutes = 45;
                } else {
                    lateMinutes = late;
                    accumulatedMinutes = 45 - late;
                }
                
                // Deduct lunch late minutes from accumulation
                accumulatedMinutes -= lunchLateMinutes;
            }

            entries.push({ 
                employeeId, date: fromDate, status, location, arrivalTime, 
                lateMinutes, accumulatedMinutes, leaveTaken, comments,
                lunchGroup, lunchStart, lunchEnd, lunchLateMinutes,
                managerApproval, lunchReason,
                approvalStatus: null, approver: null, approvalReason: null
            });
            entries.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveData();
            updateAllDisplays();
            resetForm();
            
            if (lunchLateMinutes > 0) {
                alert(`Entry saved with ${lunchLateMinutes} minute lunch deduction (Approved by ${managerApproval})`);
            }
        }

        function resetForm() {
            setDefaultDate();
            document.getElementById('dayStatus').value = 'worked';
            document.getElementById('arrivalTime').value = '07:45';
            document.getElementById('menlynOffice').checked = true;
            document.getElementById('toDate').value = '';
            document.getElementById('location').value = 'KZN';
            document.getElementById('comments').value = '';
            document.getElementById('lunchStart').value = '';
            document.getElementById('lunchEnd').value = '';
            toggleLocation();
            toggleArrivalTime();
        }

        function getEmployeeEntries(empId) {
            return entries.filter(e => e.employeeId === empId);
        }

        function updateAllDisplays() {
            updateSummaryCards();
            updateMonthlyTable();
            updateBalanceTable();
            updateEmployeesList();
        }

        function updateSummaryCards() {
            const empEntries = getEmployeeEntries(currentEmployeeId);
            let totalMinutes = 0, totalTaken = 0, totalWorked = 0, monthMinutes = 0;
            const currentMonth = new Date().toISOString().slice(0, 7);
            const currentYear = new Date().getFullYear();

            empEntries.forEach(entry => {
                totalMinutes += entry.accumulatedMinutes;
                totalTaken += entry.leaveTaken;
                if (entry.status === 'worked') totalWorked++;
                if (entry.date.startsWith(currentMonth) && entry.status === 'worked') monthMinutes += entry.accumulatedMinutes;
            });

            // Sick accrual calculation:
            // As requested: 6 sick days per year; accrual = 1 sick day per 2 months worked (‚âà 40 work days).
            // We'll calculate using worked days count: 1 sick day per 40 worked days, but cap at 6 for the current year.
            const workedDaysThisYear = empEntries.filter(e => e.status === 'worked' && new Date(e.date).getFullYear() === currentYear).length;
            const sickAccruedThisYear = Math.min(6, Math.floor(workedDaysThisYear / 40)); // 1 per 40 worked days, max 6/year

            document.getElementById('totalBalance').textContent = ((totalMinutes / 480) - totalTaken).toFixed(2);
            document.getElementById('monthAccumulated').textContent = (monthMinutes / 480).toFixed(2);
            document.getElementById('totalWorked').textContent = totalWorked;
            document.getElementById('sickAccrued').textContent = sickAccruedThisYear;
        }

        function updateMonthlyTable() {
            const empEntries = getEmployeeEntries(currentEmployeeId);
            const monthlyData = {};

            empEntries.forEach(entry => {
                const month = entry.date.slice(0, 7);
                if (!monthlyData[month]) monthlyData[month] = { 
                    worked: 0, sick: 0, annual: 0, study: 0, family: 0, 
                    lateDays: 0, lunchViolations: 0, accumulatedMinutes: 0 
                };

                if (entry.status === 'worked') {
                    monthlyData[month].worked++;
                    monthlyData[month].accumulatedMinutes += entry.accumulatedMinutes;
                    if (entry.lateMinutes > 10) monthlyData[month].lateDays++;
                    if (entry.lunchLateMinutes > 0) monthlyData[month].lunchViolations++;
                } else if (entry.status === 'sick') monthlyData[month].sick++;
                else if (entry.status === 'annual') monthlyData[month].annual += entry.leaveTaken;
                else if (entry.status === 'study') monthlyData[month].study += entry.leaveTaken;
                else if (entry.status === 'family') monthlyData[month].family += entry.leaveTaken;
            });

            const tbody = document.getElementById('monthlyBody');
            if (tbody) {
                tbody.innerHTML = '';

                Object.keys(monthlyData).sort().reverse().forEach(month => {
                    const data = monthlyData[month];
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}</td>
                        <td>${data.worked}</td><td>${data.sick}</td><td>${data.annual.toFixed(2)}</td>
                        <td>${data.study.toFixed(2)}</td><td>${data.family.toFixed(2)}</td><td>${data.lateDays}</td>
                        <td>${data.lunchViolations}</td>
                        <td>${data.accumulatedMinutes}</td><td>${(data.accumulatedMinutes / 480).toFixed(2)}</td>
                    `;
                });
            }

            const emp = employees.find(e => e.id === currentEmployeeId);
            document.getElementById('monthlyEmployeeName').textContent = emp ? emp.name : '';
        }

        function updateBalanceTable() {
            const empEntries = getEmployeeEntries(currentEmployeeId);
            const tbody = document.getElementById('balanceBody');
            if (tbody) {
                tbody.innerHTML = '';
                let runningMinutes = 0;

                empEntries.forEach((entry, idx) => {
                    runningMinutes += entry.accumulatedMinutes - (entry.leaveTaken * 480);
                    const row = tbody.insertRow();
                    const statusText = { worked: 'Worked', sick: 'Sick Leave', annual: 'Annual Leave', study: 'Study Leave', family: 'Family Leave', absent: 'Absent' }[entry.status];

                    let lateBadge = '';
                    if (entry.status === 'worked') {
                        lateBadge = entry.lateMinutes === 0 ? '<span class="late-badge on-time">On Time</span>' :
                            entry.lateMinutes <= 30 ? `<span class="late-badge late">${entry.lateMinutes} min</span>` :
                            `<span class="late-badge very-late">${entry.lateMinutes} min</span>`;
                    }
                    
                    let lunchBadge = '-';
                    if (entry.status === 'worked' && entry.lunchStart && entry.lunchEnd) {
                        if (entry.lunchLateMinutes === 0) {
                            lunchBadge = `<span class="lunch-badge normal">${entry.lunchStart}-${entry.lunchEnd}</span>`;
                        } else {
                            lunchBadge = `<span class="lunch-badge pending" title="Approved by ${entry.managerApproval}">${entry.lunchStart}-${entry.lunchEnd}</span>`;
                        }
                    }

                    const commentDisplay = entry.comments ?
                        `<span class="comment-cell" onclick="showComment('${entry.comments.replace(/'/g, "\\'").replace(/\n/g, "\\n")}')">${entry.comments.substring(0, 30)}${entry.comments.length > 30 ? '[...]' : ''}</span>` :
                        '<span style="color: #ccc;">-</span>';

                    // Approval badge for leave entries
                    let approvalBadge = '';
                    if (['annual','study','family','sick'].includes(entry.status)) {
                        if (entry.approvalStatus === 'approved') approvalBadge = `<span class="approval-badge approved">Approved by ${entry.approver || '-'}</span>`;
                        else if (entry.approvalStatus === 'rejected') approvalBadge = `<span class="approval-badge rejected">Rejected by ${entry.approver || '-'}</span>`;
                        else approvalBadge = `<span class="approval-badge pending">Pending Approval</span>`;
                    }

                    // Approve / Reject buttons for leave rows
                    let approvalButtons = '';
                    if (['annual','study','family','sick'].includes(entry.status)) {
                        approvalButtons = `
                            <button class="btn btn-success" style="padding:6px 10px; font-size:12px; margin-right:6px;" onclick="openLeaveApproval('${entry.employeeId}','${entry.date}', ${idx}, 'approved')">Approve</button>
                            <button class="btn btn-danger" style="padding:6px 10px; font-size:12px;" onclick="openLeaveApproval('${entry.employeeId}','${entry.date}', ${idx}, 'rejected')">Reject</button>
                        `;
                    }

                    row.innerHTML = `
                        <td>${new Date(entry.date).toLocaleDateString()}</td>
                        <td><span class="location-badge">${entry.location}</span></td>
                        <td>${entry.arrivalTime || '-'}</td>
                        <td>${lunchBadge}</td>
                        <td>${statusText}</td><td>${lateBadge}</td>
                        <td>${entry.lunchLateMinutes > 0 ? '-' + entry.lunchLateMinutes : '-'}</td>
                        <td>${entry.accumulatedMinutes > 0 ? '+' + entry.accumulatedMinutes : entry.accumulatedMinutes}</td>
                        <td>${entry.leaveTaken > 0 ? entry.leaveTaken.toFixed(2) : '-'}</td>
                        <td><strong>${(runningMinutes / 480).toFixed(2)}</strong></td>
                        <td>${commentDisplay}</td>
                        <td>${approvalBadge}</td>
                        <td>${approvalButtons}</td>
                        <td><button class="btn" style="padding: 6px 12px; font-size: 12px; margin: 0;" onclick="editEntry(${idx})">Edit</button></td>
                    `;
                });
            }

            const emp = employees.find(e => e.id === currentEmployeeId);
            document.getElementById('balanceEmployeeName').textContent = emp ? emp.name : '';
        }

        function updateEmployeesList() {
            const container = document.getElementById('employeeList');
            container.innerHTML = '';

            employees.forEach(emp => {
                const empEntries = getEmployeeEntries(emp.id);
                let totalMinutes = 0, totalTaken = 0, totalWorked = 0;

                empEntries.forEach(entry => {
                    totalMinutes += entry.accumulatedMinutes;
                    totalTaken += entry.leaveTaken;
                    if (entry.status === 'worked') totalWorked++;
                });

                // Sick accrual for the employee this year
                const currentYear = new Date().getFullYear();
                const workedDaysThisYear = empEntries.filter(e => e.status === 'worked' && new Date(e.date).getFullYear() === currentYear).length;
                const sickAccruedThisYear = Math.min(6, Math.floor(workedDaysThisYear / 40));

                const balance = (totalMinutes / 480) - totalTaken;
                const card = document.createElement('div');
                card.className = 'employee-card';
                card.innerHTML = `
                    <h4>${emp.name}</h4>
                    <p style="color: #666; font-size: 13px; margin-bottom: 10px;">ID: ${emp.employeeId} | Lunch Group ${emp.lunchGroup || 'A'}</p>
                    <div class="employee-stats">
                        <div><div class="label">Balance</div><div class="stat-value">${balance.toFixed(2)}</div></div>
                        <div><div class="label">Days Worked</div><div class="stat-value">${totalWorked}</div></div>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <div style="flex:1; background:white; border-radius:6px; padding:8px; text-align:center;">
                            <div style="font-size:11px;color:#666;">Sick Accrued</div>
                            <div style="font-weight:700;color:#667eea;font-size:18px;">${sickAccruedThisYear}</div>
                        </div>
                        <div style="flex:1; background:white; border-radius:6px; padding:8px; text-align:center;">
                            <div style="font-size:11px;color:#666;">Leave Taken</div>
                            <div style="font-weight:700;color:#667eea;font-size:18px;">${totalTaken.toFixed(2)}</div>
                        </div>
                    </div>
                    <button class="btn" style="width: 48%; margin-top: 15px;" onclick="viewEmployee('${emp.id}')">View</button>
                    <button class="btn btn-danger" style="width: 48%; margin-top: 15px;" onclick="deleteEmployee('${emp.id}')">Delete</button>
                `;
                container.appendChild(card);
            });
        }

        function viewEmployee(empId) {
            currentEmployeeId = empId;
            document.getElementById('employeeSelect').value = empId;
            document.getElementById('entryEmployee').value = empId;
            updateAllDisplays();
            // show monthly tab
            const monthlyTab = Array.from(document.querySelectorAll('.tab')).find(t => t.textContent.includes('Monthly'));
            if (monthlyTab) showTab({ target: monthlyTab }, 'monthly');
        }

        function deleteEmployee(empId) {
            const emp = employees.find(e => e.id === empId);
            if (employees.length === 1) {
                alert('Cannot delete last employee');
                return;
            }

            const hasEntries = entries.some(e => e.employeeId === empId);
            let msg = `Delete ${emp.name}?`;
            if (hasEntries) msg += '\n\nWARNING: All records will be deleted!';
            if (!confirm(msg)) return;

            employees = employees.filter(e => e.id !== empId);
            entries = entries.filter(e => e.employeeId !== empId);

            if (currentEmployeeId === empId) currentEmployeeId = employees[0].id;

            saveData();
            populateEmployeeSelectors();
            updateAllDisplays();
            alert(`${emp.name} deleted`);
        }

        function showTab(event, tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function clearAllData() {
            if (!confirm('Clear ALL data? Cannot be undone!')) return;
            entries = [];
            employees = [{ id: 'emp_' + Date.now(), name: 'Default Employee', employeeId: 'EMP001', lunchGroup: 'A' }];
            currentEmployeeId = employees[0].id;
            saveData();
            populateEmployeeSelectors();
            updateAllDisplays();
            alert('All data cleared');
        }

        function editEntry(idx) {
            const entry = getEmployeeEntries(currentEmployeeId)[idx];
            if (!entry) {
                alert('Entry not found');
                return;
            }

            document.getElementById('entryEmployee').value = entry.employeeId;
            document.getElementById('workDate').value = entry.date;
            document.getElementById('toDate').value = '';
            document.getElementById('dayStatus').value = entry.status;

            if (entry.location === 'Menlyn Office') {
                document.getElementById('menlynOffice').checked = true;
                toggleLocation();
            } else {
                document.getElementById('menlynOffice').checked = false;
                document.getElementById('location').value = entry.location;
                toggleLocation();
            }

            document.getElementById('arrivalTime').value = entry.arrivalTime || '07:45';
            
            // Extract original comments without lunch approval info
            let originalComments = entry.comments || '';
            if (originalComments.includes('[LUNCH LATE RETURN')) {
                const parts = originalComments.split('\n\n');
                originalComments = parts.length > 1 ? parts[1] : '';
            }
            document.getElementById('comments').value = originalComments;
            
            // Set lunch data
            if (entry.lunchGroup) {
                const lunchRadio = document.querySelector(`input[name="lunchGroup"][value="${entry.lunchGroup}"]`);
                if (lunchRadio) lunchRadio.checked = true;
            }
            document.getElementById('lunchStart').value = entry.lunchStart || '';
            document.getElementById('lunchEnd').value = entry.lunchEnd || '';

            if (['annual', 'study', 'family'].includes(entry.status)) {
                document.getElementById('leaveTaken').value = entry.leaveTaken;
            }

            toggleArrivalTime();
            calculateLate();
            calculateLunchPenalty();
            showTab({ target: document.querySelectorAll('.tab')[0] }, 'entry');
            alert('Entry loaded. Modify and click "Add Entry" to save.');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ====== Leave approval flow ======
        function openLeaveApproval(empId, entryDate, entryIndex, action) {
            leaveApprovalContext = { empId, entryDate, action, entryIndex };
            document.getElementById('leaveApproverName').value = '';
            document.getElementById('leaveApprovalReason').value = '';
            document.getElementById('leaveApprovalModal').classList.add('active');
            // Highlight buttons appropriately (approve/reject)
            if (action === 'approved') {
                document.getElementById('leaveApproveBtn').style.display = 'inline-block';
                document.getElementById('leaveRejectBtn').style.display = 'none';
            } else {
                document.getElementById('leaveApproveBtn').style.display = 'none';
                document.getElementById('leaveRejectBtn').style.display = 'inline-block';
            }
        }

        function closeLeaveApprovalModal() {
            document.getElementById('leaveApprovalModal').classList.remove('active');
            leaveApprovalContext = { empId: null, entryDate: null, action: null, entryIndex: null };
        }

        function confirmLeaveApproval(result) {
            const approver = document.getElementById('leaveApproverName').value.trim();
            const reason = document.getElementById('leaveApprovalReason').value.trim();
            if (!approver) {
                alert('Please enter approver name');
                return;
            }
            const ctx = leaveApprovalContext;
            if (!ctx || !ctx.empId || !ctx.entryDate) {
                alert('Approval context missing');
                closeLeaveApprovalModal();
                return;
            }

            // Find global entry index
            const globalIndex = entries.findIndex(e => e.employeeId === ctx.empId && e.date === ctx.entryDate);
            if (globalIndex < 0) {
                alert('Entry not found');
                closeLeaveApprovalModal();
                return;
            }

            entries[globalIndex].approvalStatus = result; // 'approved' or 'rejected'
            entries[globalIndex].approver = approver;
            entries[globalIndex].approvalReason = reason || null;

            saveData();
            updateAllDisplays();
            closeLeaveApprovalModal();
            alert(`Leave ${result === 'approved' ? 'approved' : 'rejected'} by ${approver}`);
        }

        // ====== Export changes: add note header ======
        function exportToCSV() {
            const emp = employees.find(e => e.id === currentEmployeeId);
            const empEntries = getEmployeeEntries(currentEmployeeId);
            let csv = `Generated by: Tsiku Leave Tracker - Beautiful and Nice Reports\nEmployee: ${emp.name} (${emp.employeeId}) - Lunch Group ${emp.lunchGroup || 'A'}\nDate,Location,Arrival,Lunch Time,Lunch Late,Manager Approval,Status,Late,Lunch Deduct,Mins,Leave,Approval,Approver,Comments\n`;
            let runningMinutes = 0;

            empEntries.forEach(entry => {
                runningMinutes += entry.accumulatedMinutes - (entry.leaveTaken * 480);
                const comment = (entry.comments || '').replace(/"/g, '""');
                const lunchTime = (entry.lunchStart && entry.lunchEnd) ? `${entry.lunchStart}-${entry.lunchEnd}` : '-';
                csv += `${entry.date},${entry.location || '-'},${entry.arrivalTime || '-'},${lunchTime},${entry.lunchLateMinutes || 0},${entry.managerApproval || '-'},${entry.status},${entry.lateMinutes || 0},${entry.lunchLateMinutes || 0},${entry.accumulatedMinutes || 0},${entry.leaveTaken || 0},${entry.approvalStatus || '-'},${entry.approver || '-'},"${comment}"\n`;
            });

            downloadCSV(csv, `leave_tracker_${emp.employeeId}.csv`);
        }

        function exportAllEmployeesCSV() {
            let csv = 'Generated by: Tsiku Leave Tracker - Beautiful and Nice Reports\nEmployee,ID,Lunch Group,Date,Location,Arrival,Lunch Time,Lunch Late,Manager Approval,Status,Late,Lunch Deduct,Mins,Leave,Balance,Approval,Approver,Comments\n';

            employees.forEach(emp => {
                const empEntries = getEmployeeEntries(emp.id);
                let runningMinutes = 0;

                empEntries.forEach(entry => {
                    runningMinutes += entry.accumulatedMinutes - (entry.leaveTaken * 480);
                    const comment = (entry.comments || '').replace(/"/g, '""');
                    const lunchTime = (entry.lunchStart && entry.lunchEnd) ? `${entry.lunchStart}-${entry.lunchEnd}` : '-';
                    
                    csv += `${emp.name},${emp.employeeId},${emp.lunchGroup || 'A'},${entry.date},${entry.location || '-'},${entry.arrivalTime || '-'},${lunchTime},${entry.lunchLateMinutes || 0},${entry.managerApproval || '-'},${entry.status},${entry.lateMinutes || 0},${entry.lunchLateMinutes || 0},${entry.accumulatedMinutes || 0},${entry.leaveTaken || 0},${(runningMinutes/480).toFixed(2)},${entry.approvalStatus || '-'},${entry.approver || '-'},"${comment}"\n`;
                });
            });

            downloadCSV(csv, 'leave_tracker_all_employees.csv');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setDefaultDate();
            toggleLocation();
            updateAllDisplays();
        });
    </script>
</body>
</html>
