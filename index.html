<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tsiku Leave Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand-1:#667eea;
      --brand-2:#764ba2;
      --muted:#666;
      --card-bg:#ffffff;
      --page-bg:linear-gradient(135deg,var(--brand-1) 0%,var(--brand-2) 100%);
      --shadow:0 10px 30px rgba(0,0,0,0.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:var(--page-bg);color:#222;min-height:100vh;padding:28px;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .container{max-width:1200px;margin:0 auto}

    .header{background:var(--card-bg);padding:20px;border-radius:12px;box-shadow:var(--shadow);margin-bottom:20px}
    .header-top{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap}
    .header-left{display:flex;gap:16px;align-items:center}
    #logo{height:64px;width:auto}
    h1{color:var(--brand-1);font-size:22px;margin:0}
    .info{color:var(--muted);font-size:13px;margin-top:6px}

    .rules-box,.lunch-box{background:#f7f9ff;padding:12px;border-radius:8px;border-left:4px solid var(--brand-1);margin-top:12px;color:#333}
    .lunch-box{background:#fff8e6;border-left-color:#ffc107}

    .employee-selector{display:flex;gap:10px;align-items:center}
    select,input,textarea,button{font-family:inherit}
    select,input[type=time],input[type=date],textarea{padding:10px;border-radius:8px;border:1px solid #e5e7eb}

    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:18px 0}
    .card{background:var(--card-bg);padding:18px;border-radius:12px;box-shadow:var(--shadow);text-align:center}
    .card h3{margin:0;color:#666;font-size:12px;text-transform:uppercase}
    .card .value{font-weight:700;font-size:28px;color:var(--brand-1);margin-top:6px}
    .card .subtext{font-size:12px;color:#888;margin-top:6px}

    .tabs{display:flex;gap:10px;margin-bottom:18px}
    .tab{background:var(--card-bg);padding:12px 18px;border-radius:10px;border:1px solid #eef2ff;cursor:pointer;font-weight:600;color:#333}
    .tab.active{background:var(--brand-1);color:white}

    .content{background:var(--card-bg);padding:20px;border-radius:12px;box-shadow:var(--shadow)}
    .section{display:none}
    .section.active{display:block}
    .input-group{margin-bottom:14px}
    .input-group label{display:block;font-weight:600;margin-bottom:6px;color:#333;font-size:13px}
    textarea{min-height:90px}

    .location-badge{display:inline-block;padding:4px 10px;border-radius:12px;background:#e6f0ff;color:#0b63b3;font-weight:700}
    .late-indicator{padding:10px;border-radius:6px;margin-top:8px;display:none}
    .late-indicator.on-time{background:#e8f6ef;color:#155724;display:block}
    .late-indicator.late{background:#fff7e6;color:#856404;display:block}
    .late-indicator.very-late{background:#fdecea;color:#721c24;display:block}

    .btn{background:var(--brand-1);color:white;padding:10px 16px;border-radius:8px;border:none;cursor:pointer}
    .btn.btn-secondary{background:#f1f5f9;color:#111}
    .btn.btn-danger{background:#dc3545}
    .btn-row{display:flex;gap:10px}

    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{padding:10px;text-align:left;border-bottom:1px solid #f3f4f6}
    th{background:#fbfbff;color:var(--brand-1);font-weight:700}

    .employee-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:12px}
    .employee-card{padding:14px;border-radius:10px;background:#fbfbff;border:1px solid #eef2ff}

    .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:2000}
    .modal.active{display:flex}
    .modal-content{background:var(--card-bg);padding:18px;border-radius:12px;max-width:520px;width:92%}

    .approval-badge{display:inline-block;padding:6px 10px;border-radius:6px;font-weight:700}
    .approval-badge.approved{background:#dff3e6;color:#14632a}
    .approval-badge.rejected{background:#fdecea;color:#7a1b1b}
    .approval-badge.pending{background:#fff4d9;color:#7a5a00}

    /* responsive tweaks */
    @media (max-width:720px){
      .header-top{flex-direction:column;align-items:flex-start}
      .employee-selector{width:100%;justify-content:space-between}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <div class="header-left">
          <img id="logo" src="assets/logo.png" alt="Tsiku logo" onerror="this.style.display='none'"/>
          <div>
            <h1>Tsiku Leave Tracker</h1>
            <div class="info">Official Arrival: 07:45 AM | Accumulation: 45 minutes per day</div>
            <div class="rules-box">
              <strong>Accumulation rules</strong>
              <ul style="margin:8px 0 0 18px;color:#444">
                <li>On time (by 07:45) = +45 min</li>
                <li>Late (after 07:45) = 45 - late minutes</li>
                <li>Sick days: no accumulation</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="employee-selector">
          <label style="font-weight:700;color:#333">View Employee:</label>
          <select id="employeeSelect" onchange="switchEmployee()"></select>
          <button class="btn" onclick="openAddEmployeeModal()">+ Add Employee</button>
        </div>
      </div>
    </div>

    <div class="cards">
      <div class="card"><h3>Total Balance</h3><div class="value" id="totalBalance">0.00</div><div class="subtext">days</div></div>
      <div class="card"><h3>This Month</h3><div class="value" id="monthAccumulated">0.00</div><div class="subtext">days</div></div>
      <div class="card"><h3>Days Worked</h3><div class="value" id="totalWorked">0</div><div class="subtext">days</div></div>
      <div class="card"><h3>Total Employees</h3><div class="value" id="totalEmployees">0</div><div class="subtext">registered</div></div>
      <div class="card"><h3>Sick Accrued (Year)</h3><div class="value" id="sickAccrued">0</div><div class="subtext">days</div></div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="showTab(event,'entry')">Record Entry</button>
      <button class="tab" onclick="showTab(event,'monthly')">Monthly Summary</button>
      <button class="tab" onclick="showTab(event,'balance')">Balance Details</button>
      <button class="tab" onclick="showTab(event,'employees')">All Employees</button>
    </div>

    <div class="content">
      <div id="entry" class="section active">
        <h2 style="color:var(--brand-1);margin-top:0">Record Daily Attendance</h2>
        <div class="input-group"><label>Employee</label><select id="entryEmployee"></select></div>
        <div class="input-group"><label>Date</label><input type="date" id="workDate"/></div>
        <div class="input-group" id="arrivalGroup"><label>Arrival Time (07:45)</label><input type="time" id="arrivalTime" value="07:45" onchange="calculateLate()"/></div>
        <div id="lateIndicator" class="late-indicator"></div>

        <div class="input-group"><label>Lunch Group</label>
          <div style="display:flex;gap:12px">
            <label><input type="radio" name="lunchGroup" value="A" checked/> Group A (12:00-13:00)</label>
            <label><input type="radio" name="lunchGroup" value="B"/> Group B (13:00-14:00)</label>
          </div>
        </div>

        <div class="input-group" id="lunchTimeGroup"><label>Lunch Start / End</label><div style="display:flex;gap:8px"><input type="time" id="lunchStart" onchange="calculateLunchPenalty()"/><input type="time" id="lunchEnd" onchange="calculateLunchPenalty()"/></div></div>
        <div id="lunchIndicator" class="late-indicator"></div>

        <div class="input-group"><label>Status</label><select id="dayStatus" onchange="toggleArrivalTime()"><option value="worked">Worked</option><option value="sick">Sick Leave</option><option value="annual">Annual Leave</option><option value="study">Study Leave</option><option value="family">Family Leave</option></select></div>
        <div class="input-group" id="leaveAmountGroup" style="display:none"><label>Leave Days</label><input type="number" id="leaveTaken" step="0.5" value="1" min="0.5" max="1"/></div>
        <div class="input-group"><label>Comments</label><textarea id="comments" placeholder="Optional"></textarea></div>
        <div class="btn-row"><button class="btn" onclick="addEntry()">Add Entry</button><button class="btn btn-secondary" onclick="resetForm()">Reset</button></div>
      </div>

      <div id="monthly" class="section">
        <h2 style="color:var(--brand-1);margin-top:0">Monthly Summary - <span id="monthlyEmployeeName"></span></h2>
        <table><thead><tr><th>Month</th><th>Days Worked</th><th>Sick</th><th>Annual</th><th>Study</th><th>Family</th><th>Late Days</th><th>Lunch Violations</th><th>Mins</th><th>Days</th></tr></thead><tbody id="monthlyBody"></tbody></table>
        <div class="export-section"><p class="report-note">Reports must be beautiful and nice.</p><div style="margin-top:8px"><button class="btn" onclick="exportToCSV()">Download CSV</button><button class="btn btn-secondary" onclick="exportAllEmployeesCSV()">Download All CSV</button></div></div>
      </div>

      <div id="balance" class="section">
        <h2 style="color:var(--brand-1);margin-top:0">Balance Details - <span id="balanceEmployeeName"></span></h2>
        <div style="overflow:auto"><table><thead><tr><th>Date</th><th>Location</th><th>Arrival</th><th>Lunch</th><th>Status</th><th>Late</th><th>Lunch Deduct</th><th>Mins</th><th>Leave</th><th>Balance</th><th>Comments</th><th>Approval</th><th>Actions</th></tr></thead><tbody id="balanceBody"></tbody></table></div>
      </div>

      <div id="employees" class="section">
        <h2 style="color:var(--brand-1);margin-top:0">All Employees</h2>
        <div class="employee-list" id="employeeList"></div>
        <div style="margin-top:12px"><button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button></div>
      </div>

    </div>
  </div>

  <!-- Add employee modal -->
  <div id="addEmployeeModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <button class="close-modal" onclick="closeAddEmployeeModal()" style="float:right;border:none;background:transparent;font-size:20px">×</button>
      <h3>Add New Employee</h3>
      <div class="input-group"><label>Employee Name</label><input id="newEmployeeName" type="text"/></div>
      <div class="input-group"><label>Employee ID</label><input id="newEmployeeId" type="text"/></div>
      <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn" onclick="addEmployee()">Add</button><button class="btn btn-secondary" onclick="closeAddEmployeeModal()">Cancel</button></div>
    </div>
  </div>

  <!-- Lunch approval modal (shows details when lunch was late) -->
  <div id="lunchApprovalModal" class="modal">
    <div class="modal-content">
      <h3>Manager Approval Required</h3>
      <div id="lunchViolationDetails" style="margin-bottom:10px;color:#333"></div>
      <div class="input-group"><label>Manager Name</label><input id="managerName" type="text"/></div>
      <div class="input-group"><label>Reason</label><textarea id="lunchReason"></textarea></div>
      <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-success" onclick="approveLunchViolation()">Approve</button><button class="btn btn-secondary" onclick="cancelLunchViolation()">Cancel</button></div>
    </div>
  </div>

  <!-- Leave approval modal -->
  <div id="leaveApprovalModal" class="modal">
    <div class="modal-content">
      <button class="close-modal" onclick="closeLeaveApprovalModal()" style="float:right;border:none;background:transparent;font-size:20px">×</button>
      <h3>Leave Approval</h3>
      <div class="input-group"><label>Approver Name</label><input id="leaveApproverName" type="text"/></div>
      <div class="input-group"><label>Comments</label><textarea id="leaveApprovalReason"></textarea></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="leaveApproveBtn" class="btn btn-success" onclick="confirmLeaveApproval('approved')">Approve</button>
        <button id="leaveRejectBtn" class="btn btn-danger" onclick="confirmLeaveApproval('rejected')">Reject</button>
        <button class="btn btn-secondary" onclick="closeLeaveApprovalModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="commentModal" class="modal">
    <div class="modal-content">
      <button onclick="closeCommentModal()" style="float:right;border:none;background:transparent;font-size:20px">×</button>
      <h3>Comments</h3>
      <pre id="commentContent" style="white-space:pre-wrap"></pre>
      <div style="display:flex;justify-content:flex-end;margin-top:10px"><button class="btn btn-secondary" onclick="closeCommentModal()">Close</button></div>
    </div>
  </div>

  <script>
    // Constants and data
    const OFFICIAL_ARRIVAL = '07:45';
    const DAILY_ACCUMULATION_MINUTES = 45;
    const LUNCH_PERIODS = { A: {start:'12:00',end:'13:00'}, B:{start:'13:00',end:'14:00'} };

    let employees = [];
    let entries = [];
    let currentEmployeeId = null;
    let pendingEntry = null;
    let leaveApprovalContext = { empId:null, entryDate:null, action:null, idx:null };

    // Helpers
    function setDefaultDate(){ const d = new Date(); const s = d.toISOString().slice(0,10); const el = document.getElementById('workDate'); if(el) el.value = s; }
    function safeGet(id){ return document.getElementById(id) || null; }
    function timeToMinutes(t){ if(!t) return 0; const [h,m] = t.split(':').map(Number); return h*60 + m; }

    // Persistence
    function loadData(){
      try {
        const se = localStorage.getItem('employees');
        const sE = localStorage.getItem('leaveEntries');
        if(se) employees = JSON.parse(se);
        if(sE) entries = JSON.parse(sE);
      } catch(e) {
        console.error('loadData parse error', e);
        employees = []; entries = [];
      }
      if(!employees.length){
        employees.push({ id: 'emp_' + Date.now(), name: 'Default Employee', employeeId: 'EMP001', lunchGroup: 'A' });
        saveData();
      }
      currentEmployeeId = employees[0].id;
      populateEmployeeSelectors();
      updateAllDisplays();
    }
    function saveData(){ localStorage.setItem('employees', JSON.stringify(employees)); localStorage.setItem('leaveEntries', JSON.stringify(entries)); }

    // UI population
    function populateEmployeeSelectors(){
      const sels = [safeGet('employeeSelect'), safeGet('entryEmployee')];
      sels.forEach(s => {
        if(!s) return;
        s.innerHTML = '';
        employees.forEach(emp => {
          const o = document.createElement('option');
          o.value = emp.id;
          o.textContent = `${emp.name} (${emp.employeeId}) - Group ${emp.lunchGroup || 'A'}`;
          s.appendChild(o);
        });
        if(currentEmployeeId) s.value = currentEmployeeId;
      });
      const totalEl = safeGet('totalEmployees'); if(totalEl) totalEl.textContent = employees.length;
    }

    function switchEmployee(){
      const el = safeGet('employeeSelect');
      if(!el) return;
      currentEmployeeId = el.value;
      const entrySel = safeGet('entryEmployee'); if(entrySel) entrySel.value = currentEmployeeId;
      updateAllDisplays();
    }

    // Arrival + lunch calculations (UI)
    function calculateLate(){
      const status = safeGet('dayStatus')?.value;
      if(status !== 'worked') return;
      const arrival = safeGet('arrivalTime')?.value;
      if(!arrival) return;
      const late = Math.round((new Date('2000-01-01 ' + arrival) - new Date('2000-01-01 ' + OFFICIAL_ARRIVAL)) / 60000);
      const ind = safeGet('lateIndicator');
      if(!ind) return;
      if(late <= 0){
        ind.className = 'late-indicator on-time';
        ind.innerHTML = '✅ On Time — full 45 minutes';
      } else {
        const acc = DAILY_ACCUMULATION_MINUTES - late;
        if(acc > 0){
          ind.className = 'late-indicator late';
          ind.innerHTML = `⚠️ ${late} min late — will accumulate ${acc} min`;
        } else {
          ind.className = 'late-indicator very-late';
          ind.innerHTML = `❌ ${late} min late — no accumulation`;
        }
      }
    }

    function calculateLunchPenalty(){
      const status = safeGet('dayStatus')?.value;
      if(status !== 'worked') return;
      const group = document.querySelector('input[name="lunchGroup"]:checked')?.value || 'A';
      const start = safeGet('lunchStart')?.value;
      const end = safeGet('lunchEnd')?.value;
      const ind = safeGet('lunchIndicator'); if(!ind) return;
      if(!start || !end){ ind.style.display = 'none'; return; }
      const scheduledEnd = timeToMinutes(LUNCH_PERIODS[group].end);
      const actualEnd = timeToMinutes(end);
      const late = Math.max(0, actualEnd - scheduledEnd);
      if(late === 0){
        ind.className = 'late-indicator on-time';
        ind.innerHTML = `✅ Lunch on time (${LUNCH_PERIODS[group].start}-${LUNCH_PERIODS[group].end})`;
        ind.style.display = 'block';
      } else {
        const remaining = DAILY_ACCUMULATION_MINUTES - late;
        ind.className = 'late-indicator very-late';
        ind.innerHTML = `❌ Lunch returned ${late} min late — deduct ${late} min. Final accumulation: ${remaining} min`;
        ind.style.display = 'block';
      }
    }

    function toggleArrivalTime(){
      const status = safeGet('dayStatus')?.value || 'worked';
      const arrivalGroup = safeGet('arrivalGroup'); if(arrivalGroup) arrivalGroup.style.display = (status === 'worked') ? 'block' : 'none';
      const leaveGroup = safeGet('leaveAmountGroup'); if(leaveGroup) leaveGroup.style.display = (['annual','study','family'].includes(status)) ? 'block' : 'none';
    }

    // Employee management
    function openAddEmployeeModal(){ safeGet('addEmployeeModal')?.classList.add('active'); safeGet('newEmployeeName').value = ''; safeGet('newEmployeeId').value = ''; }
    function closeAddEmployeeModal(){ safeGet('addEmployeeModal')?.classList.remove('active'); }
    function addEmployee(){
      const name = safeGet('newEmployeeName')?.value.trim();
      const id = safeGet('newEmployeeId')?.value.trim() || ('EMP' + (employees.length+1).toString().padStart(3,'0'));
      if(!name){ alert('Enter name'); return; }
      employees.push({ id: 'emp_' + Date.now(), name: name, employeeId: id, lunchGroup: 'A' });
      saveData(); populateEmployeeSelectors(); closeAddEmployeeModal(); updateAllDisplays();
    }

    // Add entry: handles single-day worked & leave ranges; prompts for lunch approval if lunch late
    function addEntry(){
      const employeeId = safeGet('entryEmployee')?.value;
      const date = safeGet('workDate')?.value;
      const status = safeGet('dayStatus')?.value;
      const arrival = safeGet('arrivalTime')?.value || null;
      const comments = safeGet('comments')?.value || '';
      const leaveTaken = (['annual','study','family'].includes(status) ? parseFloat(safeGet('leaveTaken')?.value || 0) : 0) || 0;

      if(!date){ alert('Select date'); return; }

      // Multi-day leave (if toDate provided)
      const toDate = safeGet('toDate')?.value;
      if(toDate && ['annual','study','family','sick'].includes(status)){
        const s = new Date(date), e = new Date(toDate);
        if(e < s){ alert('End date must be after start date'); return; }
        for(let d = new Date(s); d <= e; d.setDate(d.getDate()+1)){
          const ds = d.toISOString().slice(0,10);
          const idx = entries.findIndex(x => x.employeeId === employeeId && x.date === ds);
          if(idx >= 0) entries.splice(idx, 1);
          entries.push({
            employeeId, date: ds, status, location: 'Menlyn Office',
            arrivalTime: null, lateMinutes: 0, accumulatedMinutes: 0,
            leaveTaken, comments, lunchGroup: null, lunchStart: null, lunchEnd: null, lunchLateMinutes: 0,
            approvalStatus: null, approver: null, approvalReason: null
          });
        }
        saveData(); updateAllDisplays(); resetForm(); alert('Leave recorded'); return;
      }

      // For worked days with lunch data, check lunch late and prompt manager approval
      const lunchGroup = document.querySelector('input[name="lunchGroup"]:checked')?.value || 'A';
      const lunchStart = safeGet('lunchStart')?.value;
      const lunchEnd = safeGet('lunchEnd')?.value;

      if(status === 'worked' && lunchStart && lunchEnd){
        const scheduledEnd = timeToMinutes(LUNCH_PERIODS[lunchGroup].end);
        const actualEnd = timeToMinutes(lunchEnd);
        const lunchLate = Math.max(0, actualEnd - scheduledEnd);
        if(lunchLate > 0){
          // Save pending entry and show modal details
          pendingEntry = { employeeId, date, status, arrival, location: 'Menlyn Office', lunchGroup, lunchStart, lunchEnd, lunchLate, comments, leaveTaken };
          const emp = employees.find(e => e.id === employeeId) || {};
          safeGet('lunchViolationDetails').innerHTML = `<p><strong>Employee:</strong> ${emp.name || ''}</p><p><strong>Lunch Group:</strong> ${lunchGroup} (ends ${LUNCH_PERIODS[lunchGroup].end})</p><p><strong>Actual end:</strong> ${lunchEnd}</p><p><strong>Late by:</strong> ${lunchLate} minutes</p><p><strong>Deduction:</strong> ${lunchLate} min from daily 45 min accumulation</p>`;
          safeGet('managerName').value = ''; safeGet('lunchReason').value = '';
          safeGet('lunchApprovalModal').classList.add('active');
          return;
        }
      }

      // Otherwise compute accumulation and push
      let accumulated = 0, lateMinutes = 0;
      if(status === 'worked'){
        lateMinutes = Math.max(0, Math.round((new Date('2000-01-01 ' + (arrival || OFFICIAL_ARRIVAL)) - new Date('2000-01-01 ' + OFFICIAL_ARRIVAL)) / 60000));
        accumulated = (lateMinutes <= 0) ? DAILY_ACCUMULATION_MINUTES : Math.max(DAILY_ACCUMULATION_MINUTES - lateMinutes, 0);
      }
      entries.push({
        employeeId, date, status, location: 'Menlyn Office', arrivalTime: arrival,
        lateMinutes, accumulatedMinutes: accumulated, leaveTaken, comments,
        lunchGroup: (status === 'worked') ? lunchGroup : null,
        lunchStart: lunchStart || null, lunchEnd: lunchEnd || null, lunchLateMinutes: 0,
        approvalStatus: null, approver: null, approvalReason: null
      });
      saveData(); updateAllDisplays(); resetForm();
    }

    // Lunch approval handlers
    function approveLunchViolation(){
      const manager = safeGet('managerName')?.value.trim();
      const reason = safeGet('lunchReason')?.value.trim();
      if(!manager || !reason){ alert('Manager name and reason required'); return; }
      const p = pendingEntry;
      if(!p){ alert('No pending entry'); return; }

      // Compute accumulation: arrival lateness first, then deduct lunch late
      let accumulated = DAILY_ACCUMULATION_MINUTES;
      let lateMinutes = 0;
      if(p.arrival){
        lateMinutes = Math.max(0, Math.round((new Date('2000-01-01 ' + p.arrival) - new Date('2000-01-01 ' + OFFICIAL_ARRIVAL)) / 60000));
        if(lateMinutes > 0) accumulated = Math.max(DAILY_ACCUMULATION_MINUTES - lateMinutes, 0);
      }
      accumulated = Math.max(accumulated - p.lunchLate, 0);

      const fullComments = `[LUNCH LATE RETURN - Approved by: ${manager}]\nReason: ${reason}\n${p.comments ? '\n' + p.comments : ''}`;

      entries.push({
        employeeId: p.employeeId, date: p.date, status: p.status, location: p.location, arrivalTime: p.arrival,
        lateMinutes: lateMinutes, accumulatedMinutes: accumulated, leaveTaken: p.leaveTaken, comments: fullComments,
        lunchGroup: p.lunchGroup, lunchStart: p.lunchStart, lunchEnd: p.lunchEnd, lunchLateMinutes: p.lunchLate,
        managerApproval: manager, lunchReason: reason, approvalStatus: 'approved', approver: manager, approvalReason: reason
      });
      saveData(); pendingEntry = null; safeGet('lunchApprovalModal')?.classList.remove('active'); updateAllDisplays();
    }

    function cancelLunchViolation(){ pendingEntry = null; safeGet('lunchApprovalModal')?.classList.remove('active'); }

    // Reset and helpers
    function resetForm(){ setDefaultDate(); if(safeGet('dayStatus')) safeGet('dayStatus').value = 'worked'; if(safeGet('arrivalTime')) safeGet('arrivalTime').value = '07:45'; if(safeGet('comments')) safeGet('comments').value = ''; if(safeGet('lunchStart')) safeGet('lunchStart').value = ''; if(safeGet('lunchEnd')) safeGet('lunchEnd').value = ''; }

    // View / edit / delete employees and entries
    function getEmployeeEntries(empId){ return entries.filter(e => e.employeeId === empId).sort((a,b) => new Date(a.date) - new Date(b.date)); }

    function updateAllDisplays(){ populateEmployeeSelectors(); updateSummaryCards(); updateMonthlyTable(); updateBalanceTable(); updateEmployeesList(); }

    function updateSummaryCards(){
      if(!currentEmployeeId) return;
      const empEntries = getEmployeeEntries(currentEmployeeId);
      let totalMinutes = 0, totalTaken = 0, totalWorked = 0, monthMinutes = 0;
      const currentMonth = new Date().toISOString().slice(0,7);
      const currentYear = new Date().getFullYear();
      empEntries.forEach(en => {
        totalMinutes += en.accumulatedMinutes || 0;
        totalTaken += en.leaveTaken || 0;
        if(en.status === 'worked') totalWorked++;
        if(en.date.startsWith(currentMonth) && en.status === 'worked') monthMinutes += en.accumulatedMinutes || 0;
      });
      const workedDaysThisYear = empEntries.filter(e => e.status === 'worked' && new Date(e.date).getFullYear() === currentYear).length;
      const sickAccrued = Math.min(6, Math.floor(workedDaysThisYear / 40));
      safeGet('totalBalance').textContent = ((totalMinutes / 480) - totalTaken).toFixed(2);
      safeGet('monthAccumulated').textContent = (monthMinutes / 480).toFixed(2);
      safeGet('totalWorked').textContent = totalWorked;
      safeGet('sickAccrued').textContent = sickAccrued;
    }

    function updateMonthlyTable(){
      const empEntries = getEmployeeEntries(currentEmployeeId);
      const monthly = {};
      empEntries.forEach(entry => {
        if(!entry.date) return;
        const m = entry.date.slice(0,7);
        if(!monthly[m]) monthly[m] = { worked:0, sick:0, annual:0, study:0, family:0, lateDays:0, lunchViolations:0, accumulatedMinutes:0 };
        if(entry.status === 'worked'){
          monthly[m].worked++;
          monthly[m].accumulatedMinutes += entry.accumulatedMinutes || 0;
          if(entry.lateMinutes > 0) monthly[m].lateDays++;
          if(entry.lunchLateMinutes > 0) monthly[m].lunchViolations++;
        } else if(entry.status === 'sick') monthly[m].sick++;
        else if(entry.status === 'annual') monthly[m].annual += entry.leaveTaken || 0;
        else if(entry.status === 'study') monthly[m].study += entry.leaveTaken || 0;
        else if(entry.status === 'family') monthly[m].family += entry.leaveTaken || 0;
      });
      const tbody = safeGet('monthlyBody');
      if(tbody){ tbody.innerHTML = ''; Object.keys(monthly).sort().reverse().forEach(m => {
        const d = monthly[m];
        const row = tbody.insertRow();
        row.innerHTML = `<td>${new Date(m + '-01').toLocaleDateString(undefined,{year:'numeric',month:'long'})}</td><td>${d.worked}</td><td>${d.sick}</td><td>${d.annual.toFixed(2)}</td><td>${d.study.toFixed(2)}</td><td>${d.family.toFixed(2)}</td><td>${d.lateDays}</td><td>${d.lunchViolations}</td><td>${d.accumulatedMinutes}</td><td>${(d.accumulatedMinutes / 480).toFixed(2)}</td>`;
      }); }
      safeGet('monthlyEmployeeName').textContent = (employees.find(e => e.id === currentEmployeeId) || {}).name || '';
    }

    function updateBalanceTable(){
      const empEntries = getEmployeeEntries(currentEmployeeId);
      const tbody = safeGet('balanceBody'); if(!tbody) return;
      tbody.innerHTML = '';
      let running = 0;
      empEntries.forEach((entry, idx) => {
        running += (entry.accumulatedMinutes || 0) - ((entry.leaveTaken || 0) * 480);
        const tr = tbody.insertRow();
        const statusText = { worked:'Worked', sick:'Sick Leave', annual:'Annual Leave', study:'Study Leave', family:'Family Leave' }[entry.status] || entry.status;
        let lateBadge = '';
        if(entry.status === 'worked') { lateBadge = (entry.lateMinutes || 0) === 0 ? '<span class="late-badge on-time">On Time</span>' : `<span class="late-badge late">${entry.lateMinutes} min</span>`; }
        let lunchBadge = '-';
        if(entry.lunchStart && entry.lunchEnd) { lunchBadge = (entry.lunchLateMinutes || 0) === 0 ? `<span class="lunch-badge normal">${entry.lunchStart}-${entry.lunchEnd}</span>` : `<span class="lunch-badge pending">${entry.lunchStart}-${entry.lunchEnd}</span>`; }
        const commentDisplay = entry.comments ? `<span class="comment-cell" onclick="showComment(${JSON.stringify(entry.comments)})">${(entry.comments||'').substring(0,40)}${(entry.comments||'').length>40?'...':''}</span>` : '-';
        let approvalBadge = '';
        if(['annual','study','family','sick'].includes(entry.status)){
          if(entry.approvalStatus === 'approved') approvalBadge = `<span class="approval-badge approved">Approved</span>`;
          else if(entry.approvalStatus === 'rejected') approvalBadge = `<span class="approval-badge rejected">Rejected</span>`;
          else approvalBadge = `<span class="approval-badge pending">Pending</span>`;
        }
        let approvalButtons = '';
        if(['annual','study','family','sick'].includes(entry.status)){
          approvalButtons = `<button class="btn btn-success" onclick="openLeaveApproval('${entry.employeeId}','${entry.date}',${idx},'approved')">Approve</button> <button class="btn btn-danger" onclick="openLeaveApproval('${entry.employeeId}','${entry.date}',${idx},'rejected')">Reject</button>`;
        }
        tr.innerHTML = `<td>${new Date(entry.date).toLocaleDateString()}</td><td><span class="location-badge">${entry.location || '-'}</span></td><td>${entry.arrivalTime || '-'}</td><td>${lunchBadge}</td><td>${statusText}</td><td>${lateBadge}</td><td>${entry.lunchLateMinutes ? ('-' + entry.lunchLateMinutes) : '-'}</td><td>${entry.accumulatedMinutes ? ('+' + entry.accumulatedMinutes) : (entry.accumulatedMinutes === 0 ? '0' : '')}</td><td>${entry.leaveTaken ? entry.leaveTaken.toFixed(2) : '-'}</td><td><strong>${(running/480).toFixed(2)}</strong></td><td>${commentDisplay}</td><td>${approvalBadge}</td><td>${approvalButtons}</td>`;
      });
      safeGet('balanceEmployeeName').textContent = (employees.find(e => e.id === currentEmployeeId) || {}).name || '';
    }

    function updateEmployeesList(){
      const container = safeGet('employeeList'); if(!container) return; container.innerHTML = '';
      employees.forEach(emp => {
        const eEntries = getEmployeeEntries(emp.id);
        let totalMinutes = 0, totalTaken = 0, totalWorked = 0;
        eEntries.forEach(en => { totalMinutes += en.accumulatedMinutes || 0; totalTaken += en.leaveTaken || 0; if(en.status === 'worked') totalWorked++; });
        const currentYear = new Date().getFullYear();
        const workedThisYear = eEntries.filter(e => e.status === 'worked' && new Date(e.date).getFullYear() === currentYear).length;
        const sickAccrued = Math.min(6, Math.floor(workedThisYear / 40));
        const balance = (totalMinutes / 480) - totalTaken;
        const card = document.createElement('div'); card.className = 'employee-card';
        card.innerHTML = `<h4 style="margin:0;color:var(--brand-1)">${emp.name}</h4><div style="margin-top:8px">ID: ${emp.employeeId} | Group ${emp.lunchGroup||'A'}</div><div style="display:flex;gap:8px;margin-top:10px"><div style="flex:1;background:#fff;padding:8px;border-radius:6px;text-align:center"><div style="font-size:12px;color:#666">Balance</div><div style="font-weight:700;color:var(--brand-1)">${balance.toFixed(2)}</div></div><div style="flex:1;background:#fff;padding:8px;border-radius:6px;text-align:center"><div style="font-size:12px;color:#666">Sick</div><div style="font-weight:700;color:var(--brand-1)">${sickAccrued}</div></div></div><div style="display:flex;gap:8px;margin-top:10px"><button class="btn" onclick="viewEmployee('${emp.id}')">View</button><button class="btn btn-danger" onclick="deleteEmployee('${emp.id}')">Delete</button></div>`;
        container.appendChild(card);
      });
    }

    function viewEmployee(empId){
      currentEmployeeId = empId;
      safeGet('employeeSelect').value = empId;
      safeGet('entryEmployee').value = empId;
      updateAllDisplays();
      // switch to monthly tab
      const tabs = document.querySelectorAll('.tab'); if(tabs[1]) showTab({ target: tabs[1] }, 'monthly');
    }

    function deleteEmployee(empId){
      if(!confirm('Delete employee and all records?')) return;
      employees = employees.filter(e => e.id !== empId);
      entries = entries.filter(e => e.employeeId !== empId);
      if(!employees.length) employees.push({ id: 'emp_' + Date.now(), name: 'Default Employee', employeeId: 'EMP001', lunchGroup: 'A' });
      currentEmployeeId = employees[0].id;
      saveData(); populateEmployeeSelectors(); updateAllDisplays();
    }

    // Leave approval modal flow
    function openLeaveApproval(empId, entryDate, idx, action){
      leaveApprovalContext = { empId, entryDate, action, idx };
      safeGet('leaveApproverName').value = '';
      safeGet('leaveApprovalReason').value = '';
      safeGet('leaveApprovalModal').classList.add('active');
      // optional: show/hide approve/reject buttons based on action
    }
    function closeLeaveApprovalModal(){ safeGet('leaveApprovalModal').classList.remove('active'); leaveApprovalContext = { empId:null, entryDate:null, action:null, idx:null }; }
    function confirmLeaveApproval(result){
      const approver = safeGet('leaveApproverName').value.trim(); const reason = safeGet('leaveApprovalReason').value.trim();
      if(!approver){ alert('Enter approver name'); return; }
      const ctx = leaveApprovalContext; if(!ctx || !ctx.empId || !ctx.entryDate){ alert('Approval context missing'); closeLeaveApprovalModal(); return; }
      const globalIndex = entries.findIndex(e => e.employeeId === ctx.empId && e.date === ctx.entryDate);
      if(globalIndex < 0){ alert('Entry not found'); closeLeaveApprovalModal(); return; }
      entries[globalIndex].approvalStatus = result;
      entries[globalIndex].approver = approver;
      entries[globalIndex].approvalReason = reason || null;
      saveData(); updateAllDisplays(); closeLeaveApprovalModal(); alert('Done');
    }

    // Exports
    function exportToCSV(){
      const emp = employees.find(e => e.id === currentEmployeeId) || employees[0];
      let csv = `Generated by: Tsiku Leave Tracker - Beautiful and Nice Reports\nEmployee: ${emp.name} (${emp.employeeId})\nDate,Location,Arrival,Lunch,LunchLate,Status,Late,AccumMins,Leave,Approval,Approver,Comments\n`;
      getEmployeeEntries(emp.id).forEach(en => {
        const lunch = (en.lunchStart && en.lunchEnd) ? `${en.lunchStart}-${en.lunchEnd}` : '-';
        const comment = (en.comments || '').replace(/"/g, '""');
        csv += `${en.date},${en.location || '-'},${en.arrivalTime || '-'},${lunch},${en.lunchLateMinutes || 0},${en.status || '-'},${en.lateMinutes || 0},${en.accumulatedMinutes || 0},${en.leaveTaken || 0},${en.approvalStatus || '-'},${en.approver || '-'},"${comment}"\n`;
      });
      downloadCSV(csv, `leave_tracker_${emp.employeeId || 'employee'}.csv`);
    }

    function exportAllEmployeesCSV(){
      let csv = `Generated by: Tsiku Leave Tracker - Beautiful and Nice Reports\nEmployee,ID,Lunch Group,Date,Location,Arrival,Lunch,LunchLate,Status,Late,AccumMins,Leave,Approval,Approver,Comments\n`;
      employees.forEach(emp => {
        getEmployeeEntries(emp.id).forEach(en => {
          const lunch = (en.lunchStart && en.lunchEnd) ? `${en.lunchStart}-${en.lunchEnd}` : '-';
          const comment = (en.comments || '').replace(/"/g, '""');
          csv += `${emp.name},${emp.employeeId},${emp.lunchGroup || 'A'},${en.date},${en.location || '-'},${en.arrivalTime || '-'},${lunch},${en.lunchLateMinutes || 0},${en.status || '-'},${en.lateMinutes || 0},${en.accumulatedMinutes || 0},${en.leaveTaken || 0},${en.approvalStatus || '-'},${en.approver || '-'},"${comment}"\n`;
        });
      });
      downloadCSV(csv, 'leave_tracker_all_employees.csv');
    }

    function downloadCSV(content, filename){
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Tabs and small UI helpers
    function showTab(event, tabName){
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      if(event && event.target) event.target.classList.add('active');
      safeGet(tabName)?.classList.add('active');
    }
    function clearAllData(){ if(!confirm('Clear ALL data? Cannot be undone!')) return; entries = []; employees = [{ id: 'emp_' + Date.now(), name: 'Default Employee', employeeId: 'EMP001', lunchGroup: 'A' }]; currentEmployeeId = employees[0].id; saveData(); populateEmployeeSelectors(); updateAllDisplays(); alert('All data cleared'); }

    function showComment(c){ if(!c || !c.trim()){ alert('No comments'); return; } safeGet('commentContent').textContent = c; safeGet('commentModal').classList.add('active'); }
    function closeCommentModal(){ safeGet('commentModal').classList.remove('active'); }

    // Initialize
    document.addEventListener('DOMContentLoaded', function(){
      loadData();
      setDefaultDate();
      toggleArrivalTime();
      // Attach defensive listeners to avoid errors if elements missing
      ['arrivalTime','dayStatus','lunchStart','lunchEnd'].forEach(id => {
        const el = safeGet(id); if(el) el.addEventListener('change', () => { calculateLate(); calculateLunchPenalty(); });
      });
    });
  </script>
</body>
</html>
