<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tsiku Leave Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand-1:#667eea;
      --brand-2:#764ba2;
      --muted:#666;
      --card-bg:#ffffff;
      --page-bg:linear-gradient(135deg,var(--brand-1) 0%,var(--brand-2) 100%);
      --shadow:0 10px 30px rgba(0,0,0,0.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:var(--page-bg);color:#222;min-height:100vh;padding:28px;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .container{max-width:1200px;margin:0 auto}

    .header{background:var(--card-bg);padding:20px;border-radius:12px;box-shadow:var(--shadow);margin-bottom:20px}
    .header-top{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap}
    .header-left{display:flex;gap:16px;align-items:center}
    #logo{height:64px;width:auto}
    h1{color:var(--brand-1);font-size:22px;margin:0}
    .info{color:var(--muted);font-size:13px;margin-top:6px}

    .rules-box,.lunch-box{background:#f7f9ff;padding:12px;border-radius:8px;border-left:4px solid var(--brand-1);margin-top:12px;color:#333}
    .lunch-box{background:#fff8e6;border-left-color:#ffc107}

    .employee-selector{display:flex;gap:10px;align-items:center}
    select,input,textarea,button{font-family:inherit}
    select,input[type=time],input[type=date],textarea{padding:10px;border-radius:8px;border:1px solid #e5e7eb}

    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:18px 0}
    .card{background:var(--card-bg);padding:18px;border-radius:12px;box-shadow:var(--shadow);text-align:center}
    .card h3{margin:0;color:#666;font-size:12px;text-transform:uppercase}
    .card .value{font-weight:700;font-size:28px;color:var(--brand-1);margin-top:6px}
    .card .subtext{font-size:12px;color:#888;margin-top:6px}

    .tabs{display:flex;gap:10px;margin-bottom:18px}
    .tab{background:var(--card-bg);padding:12px 18px;border-radius:10px;border:1px solid #eef2ff;cursor:pointer;font-weight:600;color:#333}
    .tab.active{background:var(--brand-1);color:white}

    .content{background:var(--card-bg);padding:20px;border-radius:12px;box-shadow:var(--shadow)}
    .section{display:none}
    .section.active{display:block}
    .input-group{margin-bottom:14px}
    .input-group label{display:block;font-weight:600;margin-bottom:6px;color:#333;font-size:13px}
    textarea{min-height:90px}

    .location-badge{display:inline-block;padding:4px 10px;border-radius:12px;background:#e6f0ff;color:#0b63b3;font-weight:700}
    .late-indicator{padding:10px;border-radius:6px;margin-top:8px;display:none}
    .late-indicator.on-time{background:#e8f6ef;color:#155724;display:block}
    .late-indicator.late{background:#fff7e6;color:#856404;display:block}
    .late-indicator.very-late{background:#fdecea;color:#721c24;display:block}

    .btn{background:var(--brand-1);color:white;padding:10px 16px;border-radius:8px;border:none;cursor:pointer}
    .btn.btn-secondary{background:#f1f5f9;color:#111}
    .btn.btn-danger{background:#dc3545}
    .btn-row{display:flex;gap:10px}

    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{padding:10px;text-align:left;border-bottom:1px solid #f3f4f6}
    th{background:#fbfbff;color:var(--brand-1);font-weight:700}

    .employee-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:12px}
    .employee-card{padding:14px;border-radius:10px;background:#fbfbff;border:1px solid #eef2ff}

    .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:2000}
    .modal.active{display:flex}
    .modal-content{background:var(--card-bg);padding:18px;border-radius:12px;max-width:520px;width:92%}

    .approval-badge{display:inline-block;padding:6px 10px;border-radius:6px;font-weight:700}
    .approval-badge.approved{background:#dff3e6;color:#14632a}
    .approval-badge.rejected{background:#fdecea;color:#7a1b1b}
    .approval-badge.pending{background:#fff4d9;color:#7a5a00}

    /* responsive tweaks */
    @media (max-width:720px){
      .header-top{flex-direction:column;align-items:flex-start}
      .employee-selector{width:100%;justify-content:space-between}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <div class="header-left">
          <img id="logo" src="assets/logo.svg" alt="Tsiku logo" onerror="this.style.display='none'"/>
          <div>
            <h1>Tsiku Leave Tracker</h1>
            <div class="info">Official Arrival: 07:45 AM | Accumulation: 45 minutes per day</div>
            <div class="rules-box">
              <strong>Accumulation rules</strong>
              <ul style="margin:8px 0 0 18px;color:#444">
                <li>On time (by 07:45) = +45 min</li>
                <li>Late (after 07:45) = 45 - late minutes</li>
                <li>Sick days: no accumulation</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="employee-selector">
          <label style="font-weight:700;color:#333">View Employee:</label>
          <select id="employeeSelect" onchange="switchEmployee()"></select>
          <button class="btn" onclick="openAddEmployeeModal()">+ Add Employee</button>
        </div>
      </div>
    </div>

    <div class="cards">
      <div class="card"><h3>Total Balance</h3><div class="value" id="totalBalance">0.00</div><div class="subtext">days</div></div>
      <div class="card"><h3>This Month</h3><div class="value" id="monthAccumulated">0.00</div><div class="subtext">days</div></div>
      <div class="card"><h3>Days Worked</h3><div class="value" id="totalWorked">0</div><div class="subtext">days</div></div>
      <div class="card"><h3>Total Employees</h3><div class="value" id="totalEmployees">0</div><div class="subtext">registered</div></div>
      <div class="card"><h3>Sick Accrued (Year)</h3><div class="value" id="sickAccrued">0</div><div class="subtext">days</div></div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="showTab(event,'entry')">Record Entry</button>
      <button class="tab" onclick="showTab(event,'monthly')">Monthly Summary</button>
      <button class="tab" onclick="showTab(event,'balance')">Balance Details</button>
      <button class="tab" onclick="showTab(event,'employees')">All Employees</button>
    </div>

    <div class="content">
      <div id="entry" class="section active">
        <h2 style="color:var(--brand-1);margin-top:0">Record Daily Attendance</h2>
        <div class="input-group"><label>Employee</label><select id="entryEmployee"></select></div>
        <div class="input-group"><label>Date</label><input type="date" id="workDate"/></div>
        <div class="input-group" id="arrivalGroup"><label>Arrival Time (07:45)</label><input type="time" id="arrivalTime" value="07:45" onchange="calculateLate()"/></div>
        <div id="lateIndicator" class="late-indicator"></div>
        <div class="input-group"><label>Lunch Group</label>
          <div style="display:flex;gap:12px"><label><input type="radio" name="lunchGroup" value="A" checked/> Group A (12:00-13:00)</label><label><input type="radio" name="lunchGroup" value="B"/> Group B (13:00-14:00)</label></div>
        </div>
        <div class="input-group" id="lunchTimeGroup"><label>Lunch Start / End</label><div style="display:flex;gap:8px"><input type="time" id="lunchStart" onchange="calculateLunchPenalty()"/><input type="time" id="lunchEnd" onchange="calculateLunchPenalty()"/></div></div>
        <div id="lunchIndicator" class="late-indicator"></div>
        <div class="input-group"><label>Status</label><select id="dayStatus" onchange="toggleArrivalTime()"><option value="worked">Worked</option><option value="sick">Sick Leave</option><option value="annual">Annual Leave</option><option value="study">Study Leave</option><option value="family">Family Leave</option></select></div>
        <div class="input-group" id="leaveAmountGroup" style="display:none"><label>Leave Days</label><input type="number" id="leaveTaken" step="0.5" value="1" min="0.5" max="1"/></div>
        <div class="input-group"><label>Comments</label><textarea id="comments" placeholder="Optional"></textarea></div>
        <div class="btn-row"><button class="btn" onclick="addEntry()">Add Entry</button><button class="btn btn-secondary" onclick="resetForm()">Reset</button></div>
      </div>

      <div id="monthly" class="section">
        <h2 style="color:var(--brand-1);margin-top:0">Monthly Summary - <span id="monthlyEmployeeName"></span></h2>
        <table><thead><tr><th>Month</th><th>Days Worked</th><th>Sick</th><th>Annual</th><th>Study</th><th>Family</th><th>Late Days</th><th>Lunch Violations</th><th>Mins</th><th>Days</th></tr></thead><tbody id="monthlyBody"></tbody></table>
        <div class="export-section"><p class="report-note">Reports must be beautiful and nice.</p><div style="margin-top:8px"><button class="btn" onclick="exportToCSV()">Download CSV</button><button class="btn btn-secondary" onclick="exportAllEmployeesCSV()">Download All CSV</button></div></div>
      </div>

      <div id="balance" class="section">
        <h2 style="color:var(--brand-1);margin-top:0">Balance Details - <span id="balanceEmployeeName"></span></h2>
        <div style="overflow:auto"><table><thead><tr><th>Date</th><th>Location</th><th>Arrival</th><th>Lunch</th><th>Status</th><th>Late</th><th>Lunch Deduct</th><th>Mins</th><th>Leave</th><th>Balance</th><th>Comments</th><th>Approval</th><th>Actions</th></tr></thead><tbody id="balanceBody"></tbody></table></div>
      </div>

      <div id="employees" class="section">
        <h2 style="color:var(--brand-1);margin-top:0">All Employees</h2>
        <div class="employee-list" id="employeeList"></div>
        <div style="margin-top:12px"><button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button></div>
      </div>

    </div>
  </div>

  <!-- Add employee modal -->
  <div id="addEmployeeModal" class="modal" aria-hidden="true"><div class="modal-content"><button class="close-modal" onclick="closeAddEmployeeModal()" style="float:right;border:none;background:transparent;font-size:20px">×</button><h3>Add New Employee</h3><div class="input-group"><label>Employee Name</label><input id="newEmployeeName" type="text"/></div><div class="input-group"><label>Employee ID</label><input id="newEmployeeId" type="text"/></div><div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn" onclick="addEmployee()">Add</button><button class="btn btn-secondary" onclick="closeAddEmployeeModal()">Cancel</button></div></div></div>

  <!-- Lunch approval modal -->
  <div id="lunchApprovalModal" class="modal"><div class="modal-content"><h3>Manager Approval Required</h3><div class="input-group"><label>Manager Name</label><input id="managerName" type="text"/></div><div class="input-group"><label>Reason</label><textarea id="lunchReason"></textarea></div><div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-success" onclick="approveLunchViolation()">Approve</button><button class="btn btn-secondary" onclick="cancelLunchViolation()">Cancel</button></div></div></div>

  <!-- Leave approval modal -->
  <div id="leaveApprovalModal" class="modal"><div class="modal-content"><button class="close-modal" onclick="closeLeaveApprovalModal()" style="float:right;border:none;background:transparent;font-size:20px">×</button><h3>Leave Approval</h3><div class="input-group"><label>Approver Name</label><input id="leaveApproverName" type="text"/></div><div class="input-group"><label>Comments</label><textarea id="leaveApprovalReason"></textarea></div><div style="display:flex;gap:8px;justify-content:flex-end"><button id="leaveApproveBtn" class="btn btn-success" onclick="confirmLeaveApproval('approved')">Approve</button><button id="leaveRejectBtn" class="btn btn-danger" onclick="confirmLeaveApproval('rejected')">Reject</button><button class="btn btn-secondary" onclick="closeLeaveApprovalModal()">Cancel</button></div></div></div>

  <div id="commentModal" class="modal"><div class="modal-content"><button onclick="closeCommentModal()" style="float:right;border:none;background:transparent;font-size:20px">×</button><h3>Comments</h3><pre id="commentContent" style="white-space:pre-wrap"></pre><div style="display:flex;justify-content:flex-end;margin-top:10px"><button class="btn btn-secondary" onclick="closeCommentModal()">Close</button></div></div></div>

  <script>
    // Keep the previous logic but add guards and small fixes
    const OFFICIAL_ARRIVAL = '07:45';
    const DAILY_ACCUMULATION_MINUTES = 45;
    const LUNCH_PERIODS = { A: {start:'12:00',end:'13:00'}, B:{start:'13:00',end:'14:00'} };

    let employees = [];
    let entries = [];
    let currentEmployeeId = null;
    let pendingEntry = null;
    let leaveApprovalContext = { empId:null, entryDate:null };

    function setDefaultDate(){const d=new Date();document.getElementById('workDate').value=d.toISOString().slice(0,10)}

    function loadData(){try{const se=localStorage.getItem('employees');const sE=localStorage.getItem('leaveEntries');if(se)employees=JSON.parse(se);if(sE)entries=JSON.parse(sE);}catch(e){console.error('loadData parse',e);employees=[];entries=[]}
      if(!employees.length){employees.push({id:'emp_'+Date.now(),name:'Default Employee',employeeId:'EMP001',lunchGroup:'A'});saveData()}currentEmployeeId=employees[0].id;populateEmployeeSelectors();updateAllDisplays();}

    function saveData(){localStorage.setItem('employees',JSON.stringify(employees));localStorage.setItem('leaveEntries',JSON.stringify(entries))}

    function populateEmployeeSelectors(){const sels=[document.getElementById('employeeSelect'),document.getElementById('entryEmployee')];sels.forEach(s=>{if(!s) return;s.innerHTML='';employees.forEach(emp=>{const o=document.createElement('option');o.value=emp.id;o.textContent=`${emp.name} (${emp.employeeId}) - Group ${emp.lunchGroup||'A'}`;s.appendChild(o)});s.value=currentEmployeeId})
      const el=document.getElementById('totalEmployees'); if(el) el.textContent=employees.length}

    function switchEmployee(){const v=document.getElementById('employeeSelect').value;currentEmployeeId=v;document.getElementById('entryEmployee').value=v;updateAllDisplays()}

    function toggleLocation(){const lg=document.getElementById('menlynOffice');if(!lg) return;document.getElementById('locationGroup').style.display=lg.checked?'none':'block'}

    function calculateLate(){const status=document.getElementById('dayStatus')?.value; if(status!=='worked') return;const arrival=document.getElementById('arrivalTime').value; if(!arrival) return;const late=Math.round((new Date('2000-01-01 '+arrival)-new Date('2000-01-01 '+OFFICIAL_ARRIVAL))/60000);const ind=document.getElementById('lateIndicator');if(!ind) return; if(late<=0){ind.className='late-indicator on-time';ind.innerHTML='✅ On Time — full 45 minutes';}else{const acc=DAILY_ACCUMULATION_MINUTES-late;if(acc>0){ind.className='late-indicator late';ind.innerHTML=`⚠️ ${late} min late — will accumulate ${acc} min`}else{ind.className='late-indicator very-late';ind.innerHTML=`❌ ${late} min late — no accumulation`}}

    function timeToMinutes(t){if(!t) return 0;const [h,m]=t.split(':').map(Number);return h*60+m}
    function calculateLunchPenalty(){const status=document.getElementById('dayStatus')?.value;if(status!=='worked')return;const group=document.querySelector('input[name="lunchGroup"]:checked')?.value||'A';const start=document.getElementById('lunchStart').value;const end=document.getElementById('lunchEnd').value;const ind=document.getElementById('lunchIndicator');if(!ind) return;if(!start||!end){ind.style.display='none';return}const scheduledEnd=timeToMin...